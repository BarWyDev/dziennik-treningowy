import{j as d}from"./jsx-runtime.D_zvdyIk.js";import{r as w}from"./index.TcFrwHGi.js";import{D as j}from"./Dialog.0K2iIL7s.js";import{B as C}from"./Button.DG6KPLDP.js";import{c as v,e as $,a as F,s as c,f as D,b as k,d as W}from"./common.D6o9g8lX.js";function N({trainings:a,startDate:n,endDate:i}){const t=v(),g=$(n,i);let l=F(t,"Raport tygodniowy",g);const h=a.reduce((r,e)=>r+e.durationMinutes,0),f=a.reduce((r,e)=>r+(e.caloriesBurned||0),0),y=a.reduce((r,e)=>r+e.ratingOverall,0)/a.length||0,u=a.filter(r=>r.ratingPhysical),x=u.length>0?u.reduce((r,e)=>r+(e.ratingPhysical||0),0)/u.length:0,s=a.filter(r=>r.ratingEnergy),m=s.length>0?s.reduce((r,e)=>r+(e.ratingEnergy||0),0)/s.length:0;t.setFontSize(14),t.setFont("times","bold"),t.setTextColor(31,41,55),t.text(c("Podsumowanie"),14,l),l+=8;const b=[["Liczba treningow",a.length.toString()],["Laczny czas",D(h)],["Spalone kalorie",f>0?`${f} kcal`:"-"],["Sr. zadowolenie",y>0?y.toFixed(1)+"/5":"-"],["Sr. samopoczucie",x>0?x.toFixed(1)+"/5":"-"],["Sr. energia",m>0?m.toFixed(1)+"/5":"-"]].map(r=>r.map(e=>c(e)));if(k(t,{startY:l,head:[],body:b,theme:"striped",headStyles:{fillColor:[37,99,235]},columnStyles:{0:{fontStyle:"bold",cellWidth:50},1:{cellWidth:"auto"}},styles:{fontSize:10,cellPadding:3},margin:{left:14,right:14}}),l=t.lastAutoTable.finalY+15,a.length>0){t.setFontSize(14),t.setFont("times","bold"),t.text(c("Lista treningow"),14,l),l+=8;const r=a.map(e=>[new Date(e.date).toLocaleDateString("pl-PL",{day:"numeric",month:"short"}),c(e.trainingType?.name||"Trening"),D(e.durationMinutes),`${e.ratingOverall}/5`,e.caloriesBurned?`${e.caloriesBurned}`:"-"]);k(t,{startY:l,head:[[c("Data"),c("Typ"),"Czas","Ocena","Kalorie"]],body:r,theme:"striped",headStyles:{fillColor:[37,99,235],textColor:255,fontStyle:"bold"},styles:{fontSize:9,cellPadding:3},columnStyles:{0:{cellWidth:30},1:{cellWidth:50},2:{cellWidth:30},3:{cellWidth:20},4:{cellWidth:25}},margin:{left:14,right:14}})}else t.setFontSize(11),t.setFont("times","normal"),t.setTextColor(107,114,128),t.text(c("Brak treningow w tym tygodniu."),14,l);W(t);const T=P(n),S=c(`raport_tygodniowy_${n.getFullYear()}_T${T}.pdf`);t.save(S)}function P(a){const n=new Date(Date.UTC(a.getFullYear(),a.getMonth(),a.getDate())),i=n.getUTCDay()||7;n.setUTCDate(n.getUTCDate()+4-i);const t=new Date(Date.UTC(n.getUTCFullYear(),0,1));return Math.ceil(((n.getTime()-t.getTime())/864e5+1)/7)}function E({trainings:a,year:n,month:i}){const t=v(),g=new Date(n,i-1,1).toLocaleDateString("pl-PL",{month:"long",year:"numeric"});let l=F(t,"Raport miesięczny",g.charAt(0).toUpperCase()+g.slice(1));const h=a.reduce((e,o)=>e+o.durationMinutes,0),f=a.reduce((e,o)=>e+(o.caloriesBurned||0),0),y=a.reduce((e,o)=>e+o.ratingOverall,0)/a.length||0,u=a.filter(e=>e.ratingPhysical),x=u.length>0?u.reduce((e,o)=>e+(o.ratingPhysical||0),0)/u.length:0,s=a.filter(e=>e.ratingEnergy),m=s.length>0?s.reduce((e,o)=>e+(o.ratingEnergy||0),0)/s.length:0,b=a.reduce((e,o)=>{const p=o.trainingType?.name||"Inne";return e[p]||(e[p]={count:0,duration:0}),e[p].count++,e[p].duration+=o.durationMinutes,e},{});t.setFontSize(14),t.setFont("times","bold"),t.setTextColor(31,41,55),t.text(c("Podsumowanie"),14,l),l+=8;const T=[["Liczba treningow",a.length.toString()],["Laczny czas",D(h)],["Sredni czas treningu",a.length>0?D(Math.round(h/a.length)):"-"],["Spalone kalorie",f>0?`${f} kcal`:"-"],["Sr. zadowolenie",y>0?y.toFixed(1)+"/5":"-"],["Sr. samopoczucie",x>0?x.toFixed(1)+"/5":"-"],["Sr. energia",m>0?m.toFixed(1)+"/5":"-"]].map(e=>e.map(o=>c(o)));if(k(t,{startY:l,head:[],body:T,theme:"striped",columnStyles:{0:{fontStyle:"bold",cellWidth:60},1:{cellWidth:"auto"}},styles:{fontSize:10,cellPadding:3},margin:{left:14,right:14}}),l=t.lastAutoTable.finalY+15,Object.keys(b).length>0){t.setFontSize(14),t.setFont("times","bold"),t.text(c("Podzial wg typu treningu"),14,l),l+=8;const e=Object.entries(b).sort((o,p)=>p[1].count-o[1].count).map(([o,p])=>[c(o),p.count.toString(),D(p.duration)]);k(t,{startY:l,head:[[c("Typ"),"Liczba","Czas"]],body:e,theme:"striped",headStyles:{fillColor:[37,99,235],textColor:255,fontStyle:"bold"},styles:{fontSize:10,cellPadding:3},margin:{left:14,right:14}}),l=t.lastAutoTable.finalY+15}if(a.length>0){t.setFontSize(14),t.setFont("times","bold"),t.text(c("Lista treningow"),14,l),l+=8;const e=a.map(o=>[new Date(o.date).toLocaleDateString("pl-PL",{day:"numeric",month:"short"}),c(o.trainingType?.name||"Trening"),D(o.durationMinutes),`${o.ratingOverall}/5`,o.caloriesBurned?`${o.caloriesBurned}`:"-"]);k(t,{startY:l,head:[[c("Data"),c("Typ"),"Czas","Ocena","Kalorie"]],body:e,theme:"striped",headStyles:{fillColor:[37,99,235],textColor:255,fontStyle:"bold"},styles:{fontSize:9,cellPadding:3},columnStyles:{0:{cellWidth:30},1:{cellWidth:50},2:{cellWidth:30},3:{cellWidth:20},4:{cellWidth:25}},margin:{left:14,right:14}})}else t.setFontSize(11),t.setFont("times","normal"),t.setTextColor(107,114,128),t.text(c("Brak treningow w tym miesiacu."),14,l);W(t);const S=i.toString().padStart(2,"0"),r=c(`raport_miesieczny_${n}_${S}.pdf`);t.save(r)}function _(){const[a,n]=w.useState(!1),[i,t]=w.useState("weekly"),[g,l]=w.useState(!1),[h,f]=w.useState(()=>L(new Date)),[y,u]=w.useState(()=>{const s=new Date;return`${s.getFullYear()}-${String(s.getMonth()+1).padStart(2,"0")}`});w.useEffect(()=>{const s=()=>n(!0);return window.addEventListener("open-period-export",s),()=>window.removeEventListener("open-period-export",s)},[]);const x=async()=>{l(!0);try{let s,m;if(i==="weekly"){const[r,e]=h.split("-W").map(Number),o=z(r,e);s=o.start.toISOString().split("T")[0],m=o.end.toISOString().split("T")[0]}else{const[r,e]=y.split("-").map(Number);s=`${r}-${String(e).padStart(2,"0")}-01`;const o=new Date(r,e,0).getDate();m=`${r}-${String(e).padStart(2,"0")}-${o}`}const b=await fetch(`/api/trainings?startDate=${s}&endDate=${m}&limit=100`);if(!b.ok)throw new Error("Failed to fetch trainings");const S=(await b.json()).data;if(i==="weekly"){const[r,e]=h.split("-W").map(Number),o=z(r,e);N({trainings:S,startDate:o.start,endDate:o.end})}else{const[r,e]=y.split("-").map(Number);E({trainings:S,year:r,month:e})}n(!1)}catch(s){console.error("Error exporting report:",s)}finally{l(!1)}};return d.jsx(j,{isOpen:a,onClose:()=>n(!1),title:"Eksportuj raport",children:d.jsxs("div",{className:"space-y-4",children:[d.jsxs("div",{className:"flex gap-2",children:[d.jsx("button",{type:"button",className:`flex-1 py-2 px-4 rounded-lg text-sm lg:text-base font-medium transition-colors ${i==="weekly"?"bg-primary-600 text-white":"bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700"}`,onClick:()=>t("weekly"),children:"Tygodniowy"}),d.jsx("button",{type:"button",className:`flex-1 py-2 px-4 rounded-lg text-sm lg:text-base font-medium transition-colors ${i==="monthly"?"bg-primary-600 text-white":"bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700"}`,onClick:()=>t("monthly"),children:"Miesięczny"})]}),i==="weekly"?d.jsxs("div",{children:[d.jsx("label",{className:"block text-sm lg:text-base font-medium text-gray-700 dark:text-gray-300 mb-1",children:"Wybierz tydzień"}),d.jsx("input",{type:"week",value:h,onChange:s=>f(s.target.value),className:"w-full px-3 py-2 text-sm lg:text-base border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 rounded-lg focus:border-primary-500 focus:ring-1 focus:ring-primary-500 focus:outline-none"})]}):d.jsxs("div",{children:[d.jsx("label",{className:"block text-sm lg:text-base font-medium text-gray-700 dark:text-gray-300 mb-1",children:"Wybierz miesiąc"}),d.jsx("input",{type:"month",value:y,onChange:s=>u(s.target.value),className:"w-full px-3 py-2 text-sm lg:text-base border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 rounded-lg focus:border-primary-500 focus:ring-1 focus:ring-primary-500 focus:outline-none"})]}),d.jsxs("div",{className:"flex gap-3 pt-2",children:[d.jsxs(C,{onClick:x,isLoading:g,className:"flex-1",children:[d.jsx("svg",{className:"w-4 h-4 mr-2",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:d.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"})}),"Eksportuj PDF"]}),d.jsx(C,{variant:"secondary",onClick:()=>n(!1),children:"Anuluj"})]})]})})}function L(a){const n=a.getFullYear(),i=M(a);return`${n}-W${String(i).padStart(2,"0")}`}function M(a){const n=new Date(Date.UTC(a.getFullYear(),a.getMonth(),a.getDate())),i=n.getUTCDay()||7;n.setUTCDate(n.getUTCDate()+4-i);const t=new Date(Date.UTC(n.getUTCFullYear(),0,1));return Math.ceil(((n.getTime()-t.getTime())/864e5+1)/7)}function z(a,n){const i=new Date(a,0,1+(n-1)*7),t=i.getDay(),g=new Date(i);t<=4?g.setDate(i.getDate()-i.getDay()+1):g.setDate(i.getDate()+8-i.getDay());const l=new Date(g);return l.setDate(g.getDate()+6),{start:g,end:l}}export{_ as PeriodExportDialog};
