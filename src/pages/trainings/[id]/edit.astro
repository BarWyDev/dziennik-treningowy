---
import AppLayout from '@/layouts/AppLayout.astro';
import { TrainingForm } from '@/components/features/trainings/TrainingForm';
import { db, trainings, mediaAttachments } from '@/lib/db';
import { eq, and } from 'drizzle-orm';

const { id } = Astro.params;
const user = Astro.locals.user;

if (!id || !user) {
  return Astro.redirect('/trainings');
}

const [training] = await db
  .select()
  .from(trainings)
  .where(and(eq(trainings.id, id), eq(trainings.userId, user.id)));

if (!training) {
  return Astro.redirect('/trainings');
}

const media = await db
  .select()
  .from(mediaAttachments)
  .where(eq(mediaAttachments.trainingId, id));
---

<AppLayout title="Edytuj trening">
  <div class="max-w-xl mx-auto">
    <div class="mb-6">
      <a href={`/trainings/${id}`} class="text-primary-600 dark:text-primary-400 hover:text-primary-700 dark:hover:text-primary-300 text-sm lg:text-base font-medium">
        &larr; Powrót do szczegółów
      </a>
    </div>

    <div class="bg-white dark:bg-[#161b22] rounded-xl shadow-sm border border-gray-200 dark:border-gray-800 p-6">
      <h1 class="text-2xl lg:text-3xl font-bold text-gray-900 dark:text-gray-100 mb-6">Edytuj trening</h1>
      <TrainingForm training={{ ...training, media }} client:load />
    </div>
  </div>
</AppLayout>
